@model SecretSanta.Data.Models.Wish

<div class="modal-content">
    <div class="modal-header">
        <h4 class="modal-title">@Model.Title</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
    </div>
    <div class="modal-body">
        <div class="col-lg-6">
            <div class="qwick-view-content">
                <div class="form">
                    <form id="SaveChanges" data-model="@Model.Id">
                        <input class="mt-10" name="Id" value="@Model.Id" hidden="true" />
                        <input class="mt-10" name="UserId" value="@Model.UserId" hidden="true" />
                        <label>
                            Title
                            <input class="mt-10" name="Title" placeholder="Ttile" value="@Model.Title" />
                        </label>
                        <label>
                            Price
                            <input class="mt-10" name="Price" type="number" step="0.1" placeholder="Price" value="@Math.Round(Convert.ToDouble(Model.Price), 2)" />
                        </label>
                        <label>
                            Link to shop
                            <input class="mt-10" name="LinkToShop" placeholder="Link" value="@Model.LinkToShop" />
                        </label>
                        <label>
                            Description
                            <textarea class="mt-10" name="Description" placeholder="Description">@Model.Description</textarea>
                        </label>
                        @*<div class="button-box mt-20">
                            <a class="action-plus btn-style cr-btn btn-wish-add save-changes" href="#">
                                <span>Save Changes</span>
                            </a>
                            <a class="action-plus btn-style cr-btn" href="#">
                                <span>Delete</span>
                            </a>
                        </div>*@
                    </form>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="qwick-view-content">
                <div class="text-center">
                    <div class="tab-pane active show fade mt-10" id="modal1" role="tabpanel">
                        @if (Model.PathToPicture == null)
                        {
                            <img class="item-pic" src="@Url.Content($"~/Files/default-gift.jpg")" alt="" width="290" height="368" />
                        }
                        else
                        {
                            <img class="item-pic" src="@Url.Content($"~/Files/{Model.PathToPicture}")" alt="" width="290" height="368" />
                        }
                    </div>
                    <div class="button-box mt-20">
                        <a class="action-plus btn-style cr-btn btn-wish-add" title="Choose photo">
                            <span onclick="document.getElementById('file-input-image').click();">Open...</span>
                            <input id="file-input-image" type="file" name="avatar" style="display: none;" accept="image/jpeg,image/png" data-wish="@Model.Id" />
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="lg-col-12 pb-30 ml-30 mr-30">
        <div class="button-box text-center">
            <a class="action-plus btn-style cr-btn btn-wish-add save-changes mr-15" href="#">
                <span>Save Changes</span>
            </a>
            <a class="action-plus btn-style cr-btn" href="#">
                <span>Delete</span>
            </a>
        </div>
    </div>
</div>
@Scripts.Render("~/bundles/SecretSanta/scripts")
@Scripts.Render("~/bundles/alertify/js")

<script>
    //TODO refactoring
    const sendBtn = document.querySelector('.save-changes');
    sendBtn.addEventListener('click', (event) => {
        event.preventDefault();
        const formData = document.querySelector('#SaveChanges');
        const img = document.querySelector('.item-pic');
        const data = {};
        const arr = formData.elements;
        Array.from(arr).forEach(el => {
            data[el.name] = el.value;
        });
        let pathToPicture = img.src.match(/Files\/.*/gi)[0].substring(6);
        data["pathToPicture"] = pathToPicture;
        const promise = AjaxRequest.ajaxSendForm(data, 'https://localhost:44360/api/ChangeWish');
        promise
            .then(res => {
                const closeBtn = document.querySelector('.close');
                const wishImg = document.querySelector(`#img${data.Id}`);
                wishImg.src = "@Url.Content($"~/Files/")" + pathToPicture;
                const wishTitle = document.querySelector(`#title${data.Id}`);
                wishTitle.innerHTML = data.Title;
                closeBtn.click();
                Notifier.showSuccess("<strong>Wish changed!</strong>", '<br><p>Your wish was changed!</p>')
            })
            .catch(err => {
                console.log(err)
            })
    });

</script>
<script>
    //TODO refactoring
    const inputFile = document.getElementById('file-input-image');
    const wishId = inputFile.dataset.wish;
    inputFile.addEventListener('change', (event) => {
        event.preventDefault();
        var dataFile = new FormData();
        dataFile.append('file', inputFile.files[0]);
        dataFile.append('wishId', wishId);
        fetch("https://localhost:44360/api/UploadImage", {

            method: 'POST',
            body: dataFile
        })
            .then(res => res.json())
            .then(src => {
                const itemPic = document.querySelector('.item-pic');
                itemPic.src = `/Files/${src}`;
            });

    })
</script>

